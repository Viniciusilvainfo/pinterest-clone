<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pinterest Clone</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50">
    <!-- Navbar -->
    <nav class="flex items-center justify-between px-6 py-4 bg-white shadow">
        <div class="text-2xl font-bold text-red-500">MyPins</div>
        <div class="space-x-4">
            <% if (user) { %>
                <span class="text-gray-700">Hello, <%= user.name %></span>
                <a href="/upload" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">Upload
                    Pin</a>
                <form action="/logout" method="POST" class="inline">
                    <button type="submit" class="text-gray-700 hover:text-red-500">Logout</button>
                </form>
                <% } else { %>
                    <a href="/login" class="text-gray-700 hover:text-red-500">Login</a>
                    <a href="/signup"
                        class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">Sign Up</a>
                    <% } %>
        </div>
    </nav>

    <!-- Filters -->
    <div class="p-6 bg-white shadow-sm">
        <div class="flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800">Explore Pins</h1>
            <div class="flex space-x-4">
                <a href="/?sortBy=recent&page=1"
                    class="px-4 py-2 rounded-lg <%= sortBy === 'recent' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700' %>">
                    Most Recent
                </a>
                <a href="/?sortBy=popular&page=1"
                    class="px-4 py-2 rounded-lg <%= sortBy === 'popular' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700' %>">
                    Most Popular
                </a>
            </div>
        </div>
    </div>

    <!-- Masonry Grid -->
    <main class="p-6">
        <div id="posts-container" class="columns-1 sm:columns-2 md:columns-3 lg:columns-4 gap-4 space-y-4">
            <% posts.forEach(post=> { %>
                <div class="break-inside-avoid mb-4 bg-white rounded-lg shadow hover:shadow-lg transition">
                    <img src="/uploads/<%= post.imageUrl %>" alt="<%= post.title %>"
                        class="w-full rounded-t-lg cursor-pointer"
                        onclick="showPostModal(<%= JSON.stringify(post).replace(/" /g, '&quot;' ) %>)">

                    <div class="p-4">
                        <h3 class="font-bold text-lg mb-2">
                            <%= post.title %>
                        </h3>
                        <% if (post.description) { %>
                            <p class="text-gray-600 mb-3">
                                <%= post.description %>
                            </p>
                            <% } %>

                                <div class="flex justify-between items-center text-sm text-gray-500">
                                    <span>By <%= post.user.name %></span>
                                    <div class="flex space-x-4">
                                        <button onclick="toggleLike(<%= post.id %>)"
                                            class="flex items-center space-x-1 <%= post.likes.some(like => like.userId === user?.id) ? 'text-red-500' : 'text-gray-500' %>">
                                            <span>‚ù§Ô∏è</span>
                                            <span id="like-count-<%= post.id %>">
                                                <%= post._count.likes %>
                                            </span>
                                        </button>
                                    </div>
                                </div>
                    </div>
                </div>
                <% }) %>
        </div>

        <!-- Pagination -->
        <% if (totalPages> 1) { %>
            <div class="flex justify-center mt-8 space-x-2">
                <% for (let i=1; i <=totalPages; i++) { %>
                    <a href="/?sortBy=<%= sortBy %>&page=<%= i %>"
                        class="px-4 py-2 rounded-lg <%= i === currentPage ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700' %>">
                        <%= i %>
                    </a>
                    <% } %>
            </div>
            <% } %>
    </main>

    <!-- Post Modal -->
    <div id="post-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 id="modal-title" class="text-2xl font-bold"></h2>
                    <button onclick="closePostModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <img id="modal-image" src="" alt="" class="w-full rounded-lg">

                    <div>
                        <p id="modal-description" class="text-gray-600 mb-4"></p>
                        <p class="text-sm text-gray-500 mb-4">By <span id="modal-author"></span></p>

                        <div class="flex space-x-4 mb-6">
                            <button id="modal-like-btn" onclick="toggleLikeModal()"
                                class="flex items-center space-x-2 px-4 py-2 rounded-lg bg-gray-100">
                                <span>‚ù§Ô∏è</span>
                                <span id="modal-like-count">0</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPostId = null;

        function showPostModal(post) {
            currentPostId = post.id;
            document.getElementById('modal-title').textContent = post.title;
            document.getElementById('modal-image').src = `/uploads/${post.imageUrl}`;
            document.getElementById('modal-description').textContent = post.description || 'No description';
            document.getElementById('modal-author').textContent = post.user.name;
            document.getElementById('modal-like-count').textContent = post._count.likes;

            const likeBtn = document.getElementById('modal-like-btn');
            const hasLiked = post.likes.some(like => like.userId === <%= user?.id || 'null' %>);
            likeBtn.className = `flex items-center space-x-2 px-4 py-2 rounded-lg ${hasLiked ? 'bg-red-100 text-red-500' : 'bg-gray-100'}`;

            document.getElementById('post-modal').classList.remove('hidden');
        }

        function closePostModal() {
            document.getElementById('post-modal').classList.add('hidden');
        }

        async function toggleLike(postId) {
            const isLoggedIn = <%= user ? 'true' : 'false' %>;
            
            if (!isLoggedIn) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch(`/posts/${postId}/like`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    const likeCountElements = document.querySelectorAll(`#like-count-${postId}`);
                    likeCountElements.forEach(element => {
                        element.textContent = result.likeCount;
                    });

                    const likeButtons = document.querySelectorAll(`[onclick="toggleLike(${postId})"]`);
                    likeButtons.forEach(likeBtn => {
                        const hasLiked = likeBtn.classList.contains('text-red-500');
                        likeBtn.className = `flex items-center space-x-1 ${hasLiked ? 'text-gray-500' : 'text-red-500'}`;

                        const icon = likeBtn.querySelector('span:first-child');
                        if (icon) {
                            icon.textContent = hasLiked ? 'ü§ç' : '‚ù§Ô∏è';
                        }
                    });
                }
            } catch (error) {
                console.error('Error toggling like:', error);
            }
        }

        async function toggleLikeModal() {
            if (!currentPostId) return;
            await toggleLike(currentPostId);

            const likeCount = parseInt(document.getElementById('modal-like-count').textContent);
            const newCount = document.querySelector(`#like-count-${currentPostId}`).textContent;
            document.getElementById('modal-like-count').textContent = newCount;

            const likeBtn = document.getElementById('modal-like-btn');
            const hasLiked = likeBtn.classList.contains('bg-red-100');
            likeBtn.className = `flex items-center space-x-2 px-4 py-2 rounded-lg ${hasLiked ? 'bg-gray-100' : 'bg-red-100 text-red-500'}`;
        }

        document.getElementById('post-modal').addEventListener('click', (e) => {
            if (e.target.id === 'post-modal') {
                closePostModal();
            }
        });
    </script>
</body>

</html>